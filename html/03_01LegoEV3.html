<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EV3 (Pybricks) ¬∑ Step 1 ‚Äì Two Beeps & Name</title>

  <link rel="stylesheet" href="../css/03_python.css" />
  <style>
    :root { --gap: 16px; }
    body { margin: 20px; font-family: sans-serif; }

    .layout { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 14px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin: 6px 0; }

    .btn { padding: 8px 14px; border: 1px solid #d1d5db; background: #f3f4f6; border-radius: 8px; cursor: pointer; }
    .btn.primary { background: #e0e7ff; }

    textarea { width: 100%; height: 240px; font-family: monospace; border:1px solid #d1d5db; border-radius:10px; padding:10px; background:#fff; }
    pre { background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; padding:10px; min-height:120px; overflow:auto; }

    dialog { border: none; border-radius: 12px; max-width: 560px; }
    dialog[open]::backdrop { background: rgba(0,0,0,.4); }
    .modal-header { padding: 10px 14px; font-weight: bold; border-bottom:1px solid #ddd; }
    .modal-body { padding: 10px 14px; max-height:60vh; overflow:auto; }
    .modal-actions { display:flex; justify-content:flex-end; gap:8px; padding:10px 14px; border-top:1px solid #ddd; }

    .status { margin-left: 10px; font-weight: 600; white-space: pre; }
    .status.running { color: #374151; }
    .status.ok { color: #16a34a; }
    .status.error { color: #dc2626; }

    #error { color: #dc2626; }
    .nav-row { margin-top:20px; display:flex; justify-content:space-between; }

    @media (max-width:900px){ .layout { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <!-- Single navigation bar -->
  <div class="nav-row">
    <a class="btn" id="go-main" href="../app/01_main.php" aria-label="Back to main">‚¨ÖÔ∏è Going to main</a>
    <a class="btn" href="../app/logout.php">üß± Logout</a>
    <a class="btn primary" id="next-btn" href="03_02LegoEV3.html">Next ‚Üí</a>
  </div>

  <header class="row" style="justify-content: space-between;">
    <div>
      <h1 id="task-title">EV3 (Pybricks) ¬∑ Step 1: Two Beeps & Name</h1>
      <p id="task-desc">
        Make your EV3 <b>beep twice</b> with a <code>wait(500)</code> pause in-between, then print your
        <b>name</b> with <code>brick.screen.print("...")</code>.
      </p>
    </div>
    <div class="row">
      <button class="btn" id="tips-btn">üí° Tips</button>
      <button class="btn" id="solution-btn">‚úÖ Solution</button>
    </div>
  </header>

  <main class="layout">
    <section class="card">
      <h2>Editor</h2>
      <div class="row">
        <button class="btn primary" id="run-btn">‚ñ∂ Run</button>
        <button class="btn" id="reset-btn">‚ü≤ Reset</button>
        <button class="btn" id="save-btn">üíæ Save</button>
        <span id="status" class="status" aria-live="polite"></span>
      </div>

<textarea id="editor" spellcheck="false">#!/usr/bin/env pybricks-micropython
from pybricks.hubs import EV3Brick
from pybricks.tools import wait

# Initialize EV3
brick = EV3Brick()

# TODO:
# 1) make a beep
# 2) wait 500 ms
# 3) make a second beep
# 4) print your name on the screen
# 5) keep it visible for a short time
</textarea>
    </section>

    <section class="card">
      <h2>Output</h2>
      <pre id="output"></pre>
      <div id="error"></div>
    </section>
  </main>

  <!-- Tips modal -->
  <dialog id="tips-modal">
    <div class="modal-header">Tips</div>
    <div class="modal-body">
      <ul id="tips-list"></ul>
    </div>
    <div class="modal-actions">
      <button class="btn" id="close-tips">Close</button>
    </div>
  </dialog>

  <!-- Solution modal -->
  <dialog id="solution-modal">
    <div class="modal-header">Solution</div>
    <div class="modal-body">
      <pre id="solution-code" style="white-space:pre-wrap;"></pre>
    </div>
    <div class="modal-actions">
      <button class="btn" id="copy-solution">Insert</button>
      <button class="btn" id="close-solution">Close</button>
    </div>
  </dialog>

  <script>
    const TASK = {
      title: "EV3 (Pybricks) ¬∑ Step 1: Two Beeps & Name",
      description: 'Make two beeps with <code>wait(500)</code> between them, then print your name with <code>brick.screen.print("...")</code>.',
      starterCode: `#!/usr/bin/env pybricks-micropython
from pybricks.hubs import EV3Brick
from pybricks.tools import wait

brick = EV3Brick()

# TODO:
# 1) make a beep
# 2) wait 500 ms
# 3) make a second beep
# 4) print your name on the screen
# 5) keep it visible for a short time
`,
      tips: [
        'Keep the shebang on top.',
        'Imports: from pybricks.hubs import EV3Brick, from pybricks.tools import wait',
        'Beep: brick.speaker.beep()',
        'Pause: wait(500)',
        'Print: brick.screen.print("Your Name")',
        'Add a final wait (wait(3000))'
      ],
      solution:
`#!/usr/bin/env pybricks-micropython
from pybricks.hubs import EV3Brick
from pybricks.tools import wait

brick = EV3Brick()

brick.speaker.beep()
wait(500)
brick.speaker.beep()
brick.screen.print("This is Alex")
wait(3000)
`,
      filename: "main.py",
      nextUrl: "03_02LegoEV3.html"
    };

    const els = {
      editor: document.getElementById("editor"),
      output: document.getElementById("output"),
      error: document.getElementById("error"),
      status: document.getElementById("status"),
      run: document.getElementById("run-btn"),
      reset: document.getElementById("reset-btn"),
      save: document.getElementById("save-btn"),
      tipsBtn: document.getElementById("tips-btn"),
      tipsModal: document.getElementById("tips-modal"),
      tipsList: document.getElementById("tips-list"),
      closeTips: document.getElementById("close-tips"),
      solutionBtn: document.getElementById("solution-btn"),
      solutionModal: document.getElementById("solution-modal"),
      solutionCode: document.getElementById("solution-code"),
      copySolution: document.getElementById("copy-solution"),
      closeSolution: document.getElementById("close-solution"),
      next: document.getElementById("next-btn")
    };

    document.title = TASK.title;
    document.getElementById("task-title").textContent = TASK.title;
    document.getElementById("task-desc").innerHTML = TASK.description;
    els.editor.value = TASK.starterCode;
    els.tipsList.innerHTML = TASK.tips.map(t=>`<li>${t}</li>`).join("");
    els.solutionCode.textContent = TASK.solution;

    function stripComments(s){
      s = s.replace(/^[ \t]*#.*$/gm, "");
      s = s.replace(/[ \t]+#.*$/gm, "");
      return s;
    }

    function validate(src){
      const code = stripComments(src);
      const errors = [];
      if(!/EV3Brick/.test(code)) errors.push("Missing EV3Brick import");
      if(!/wait/.test(code)) errors.push("Missing wait import");
      if(!/brick\s*=\s*EV3Brick\s*\(\s*\)/.test(code)) errors.push("Missing brick = EV3Brick()");
      const beeps = (code.match(/brick\.speaker\.beep\s*\(\s*\)/g) || []).length;
      if(beeps < 2) errors.push("Need 2√ó brick.speaker.beep()");
      if(!/wait\s*\(\s*500\s*\)/.test(code)) errors.push("Missing wait(500)");
      if(!/brick\.screen\.print\s*\(/.test(code)) errors.push("Missing brick.screen.print(...)");
      return errors;
    }

    els.run.onclick = () => {
      els.output.textContent = "";
      els.error.textContent = "";
      const errs = validate(els.editor.value);
      if(errs.length){
        els.error.textContent = errs.join("\\n");
        els.status.textContent = "ERROR";
        els.status.className = "status error";
      } else {
        els.output.textContent = "[BEEP]\\n[WAIT 500 ms]\\n[BEEP]\\n[SCREEN] Your Name";
        els.status.textContent = "OK";
        els.status.className = "status ok";
      }
    };

    els.reset.onclick = () => {
      els.editor.value = TASK.starterCode;
      els.output.textContent = "";
      els.error.textContent = "";
      els.status.textContent = "";
    };

    els.save.onclick = () => {
      const blob = new Blob([els.editor.value], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = TASK.filename;
      a.click();
      URL.revokeObjectURL(a.href);
    };

    els.tipsBtn.onclick = ()=>els.tipsModal.showModal();
    els.closeTips.onclick = ()=>els.tipsModal.close();
    els.solutionBtn.onclick = ()=>els.solutionModal.showModal();
    els.closeSolution.onclick = ()=>els.solutionModal.close();
    els.copySolution.onclick = ()=>{
      els.editor.value = TASK.solution;
      els.solutionModal.close();
    };

    els.next.onclick = ()=>location.href = TASK.nextUrl;
  </script>
</body>
</html>
