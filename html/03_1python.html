<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Python ¬∑ Step 1: Hello World</title>

  <!-- CSS jetzt lokal neben der Seite -->
  <link rel="stylesheet" href="../css/03_python.css" />

  <style>
    .status.ok { color:#15803d; }
    .status.error { color:#b91c1c; }
    .status.running { color:#374151; }
    #error { color:#b91c1c; white-space:pre-wrap; }
  </style>

  <!-- Pyodide -->
  <script
    src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"
    crossorigin="anonymous">
  </script>
</head>
<body>
  <!-- NAVIGATION -->
  <nav class="link-grid" aria-label="Topic selection">
    <a class="btn" href="../app/01_main.php" id="go-main" aria-label="Back to main">‚¨ÖÔ∏è Main</a>
    <a class="btn" href="../app/logout.php">üö™ Logout</a>
    <a class="btn primary" id="next-btn" href="03_2variables.html">Next ‚Üí</a>
  </nav>

  <header class="row" style="justify-content: space-between;">
    <div>
      <h1 id="task-title">Python ¬∑ Step 1: Hello World</h1>
      <p id="task-desc">
        Schreibe dein erstes Python-Programm.<br />
        Es soll einfach <code>Hello, World!</code> auf dem Bildschirm ausgeben.
      </p>
    </div>
    <div class="row">
      <button class="btn" id="tips-btn">üí° Tips</button>
      <button class="btn" id="solution-btn">‚úÖ Solution</button>
    </div>
  </header>

  <main class="layout">
    <!-- EDITOR -->
    <section class="card">
      <h2>Editor</h2>
      <div class="row">
        <button class="btn primary" id="run-btn">‚ñ∂ Run</button>
        <button class="btn" id="reset-btn">‚ü≤ Reset</button>
        <button class="btn" id="save-btn">üíæ Save</button>
        <span id="status" class="status" aria-live="polite"></span>
      </div>

<textarea id="editor" spellcheck="false"># TODO:
# Schreibe ein Programm, das "Hello, World!" ausgibt.
# Beispiel:
# print("Hello, World!")
</textarea>
    </section>

    <!-- OUTPUT -->
    <section class="card">
      <h2>Output</h2>
      <pre id="output"></pre>
      <div id="error"></div>
    </section>
  </main>

  <!-- Tips modal -->
  <dialog id="tips-modal">
    <div class="modal-header">Tips</div>
    <div class="modal-body">
      <ul id="tips-list"></ul>
    </div>
    <div class="modal-actions">
      <button class="btn" id="close-tips">Close</button>
    </div>
  </dialog>

  <!-- Solution modal -->
  <dialog id="solution-modal">
    <div class="modal-header">Solution</div>
    <div class="modal-body">
      <pre id="solution-code" style="white-space:pre-wrap;"></pre>
    </div>
    <div class="modal-actions">
      <button class="btn" id="copy-solution">Insert</button>
      <button class="btn" id="close-solution">Close</button>
    </div>
  </dialog>

  <script>
    // === TASK ===
    const TASK = {
      taskId: 1,
      studentNumber: 1, // TODO per Session/PHP einsetzen
      title: "Python ¬∑ Step 1: Hello World",
      description: `
        Verwende die Funktion <code>print()</code>, um Text auszugeben.<br>
        Beispiel: <code>print("Hello, World!")</code>
      `,
      starterCode:
`# Schreibe dein erstes Python-Programm hier:
print("Hello, World!")`,
      tips: [
        'Text muss in Anf√ºhrungszeichen stehen: <code>"..."</code> oder <code>\'...\'</code>.',
        '<code>print(...)</code> zeigt Text unten im Output-Feld.',
        'Achte auf Klammern: <code>print("Hello, World!")</code>.',
        'Wenn du fertig bist, klick auf ‚ñ∂ Run.'
      ],
      solution:
`# L√∂sung:
print("Hello, World!")`,
      filename: "main.py",
      nextUrl: "03_2variables.html"
    };

    // === DOM ===
    const els = {
      title:  document.getElementById("task-title"),
      desc:   document.getElementById("task-desc"),
      editor: document.getElementById("editor"),
      run:    document.getElementById("run-btn"),
      reset:  document.getElementById("reset-btn"),
      save:   document.getElementById("save-btn"),
      output: document.getElementById("output"),
      error:  document.getElementById("error"),
      status: document.getElementById("status"),
      tipsBtn: document.getElementById("tips-btn"),
      tipsModal: document.getElementById("tips-modal"),
      tipsList: document.getElementById("tips-list"),
      closeTips: document.getElementById("close-tips"),
      solutionBtn: document.getElementById("solution-btn"),
      solutionModal: document.getElementById("solution-modal"),
      solutionCode: document.getElementById("solution-code"),
      copySolution: document.getElementById("copy-solution"),
      closeSolution: document.getElementById("close-solution"),
      next: document.getElementById("next-btn")
    };

    // === INIT UI ===
    document.title = TASK.title;
    els.title.textContent = TASK.title;
    els.desc.innerHTML = TASK.description;
    els.solutionCode.textContent = TASK.solution;
    els.tipsList.innerHTML = (TASK.tips || []).map(t=>"<li>"+t+"</li>").join("");
    els.editor.value = TASK.starterCode;

    // === Status-Helfer ===
    function setStatus(cls, txt){
      els.status.className = "status " + cls;
      els.status.textContent = txt;
    }

    // === Pyodide Setup ===
    let pyReady = false;
    let py = null;

    async function ensurePyodide(){
      if (pyReady) return;
      setStatus("running","loading python‚Ä¶");

      py = await loadPyodide({
        stdout: (t)=>{ els.output.textContent += t + "\n"; },
        stderr: (t)=>{ els.error.textContent  += t + "\n"; }
      });

      pyReady = true;
      setStatus("", "");
    }

    // === Server-Event melden ===
    function sendEvent(ev){
      fetch("../../app/event_update.php", {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          task_id: String(TASK.taskId),
          nummer:  String(TASK.studentNumber),
          event:   ev
        })
      }).catch(err => console.warn("sendEvent failed:", err));
    }

    // === Run ===
    async function runCode(){
      els.output.textContent = "";
      els.error.textContent  = "";
      setStatus("running","running‚Ä¶");

      try {
        await ensurePyodide();

        const userCode = els.editor.value;
        await py.runPythonAsync(userCode);

        setStatus("ok","done.");
        sendEvent("sim"); // Erfolg melden

      } catch(err){
        setStatus("error","ERROR");
        els.error.textContent = String(err);
      }
    }

    // === Reset ===
    function reset(){
      els.editor.value = TASK.starterCode;
      els.output.textContent = "";
      els.error.textContent  = "";
      setStatus("", "");
    }

    // === Save ===
    function save(){
      const blob = new Blob([els.editor.value], {type:"text/plain"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = TASK.filename || "main.py";
      a.click();
      URL.revokeObjectURL(a.href);

      sendEvent("download");
    }

    // === Modals ===
    function openDialog(d){
      if(d?.showModal) d.showModal();
      else d?.setAttribute("open","");
    }
    function closeDialog(d){
      if(d?.close) d.close();
      else d?.removeAttribute("open");
    }

    els.tipsBtn.onclick = () => openDialog(els.tipsModal);
    els.closeTips.onclick = () => closeDialog(els.tipsModal);

    els.solutionBtn.onclick = () => openDialog(els.solutionModal);
    els.closeSolution.onclick = () => closeDialog(els.solutionModal);

    els.copySolution.onclick = () => {
      els.editor.value = els.solutionCode.textContent;
      closeDialog(els.solutionModal);

      els.output.textContent = "";
      els.error.textContent  = "";
      setStatus("", "");
    };

    // === Button Events ===
    els.run.onclick   = runCode;
    els.reset.onclick = reset;
    els.save.onclick  = save;

  </script>
</body>
</html>
