<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EV3 (ev3dev) ¬∑ Schritt 1 ‚Äì Zwei Beeps & Name</title>

  <!-- Alter Look -->
  <link rel="stylesheet" href="../css/03_python.css" />

  <!-- Mini-Styles nur f√ºr Modal-Ersatz -->
  <style>
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:9998;}
    .modal{position:fixed;inset:auto 0 0 0;margin:auto;max-width:720px;background:#fff;border:1px solid #e5e5e5;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.15);padding:16px;display:none;z-index:9999}
    .modal-header{font-weight:700;margin-bottom:8px}
    .modal-body{max-height:55vh;overflow:auto}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  </style>
</head>
<body>
  <!-- Top-Navigation -->
  <div class="nav-row" style="margin-top:20px; display:flex; justify-content:space-between;">
    <a href="01_main.html" class="btn" id="back-btn">‚Üê Back</a>
    <a href="#" class="btn primary" id="next-btn">Next ‚Üí</a>
  </div>

  <!-- Header + Aktionsbuttons -->
  <header class="row" style="justify-content: space-between;">
    <div>
      <h1 id="task-title">EV3 (ev3dev) ¬∑ Schritt 1: Zwei Beeps & Name</h1>
      <p id="task-desc">
        Aufgabe: Erzeuge <b>zwei Piept√∂ne</b> mit <b>500&nbsp;ms</b> Abstand
        und zeige deinen <b>Namen</b> am Display an.
      </p>
    </div>
    <div class="row">
      <button class="btn" id="tips-btn"  type="button">üí° Tips</button>
      <button class="btn" id="solution-btn" type="button">‚úÖ Solution</button>
    </div>
  </header>

  <main class="layout">
    <section class="card">
      <h2>Dein Code (ev3dev2 / Python 3)</h2>
      <p class="status">
        Laufzeit ist <b>ev3dev</b>: nutze <code>Sound()</code>, <code>Display()</code>, <code>sleep(0.5)</code>, <code>screen.text_grid("‚Ä¶")</code>.
      </p>

<textarea id="editor" spellcheck="false">#!/usr/bin/env python3
from ev3dev2.sound import Sound
from ev3dev2.display import Display
from time import sleep

# EV3 initialisieren
sound = Sound()
screen = Display()

# Zwei Beeps mit 500 ms Abstand
sound.beep()
sleep(0.5)
sound.beep()

# Name anzeigen
screen.clear()
screen.text_grid("Hallo, ich bin Alex", x=0, y=0, clear=False)

# Sichtbar halten
sleep(5)
</textarea>

      <!-- Steuerleiste -->
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="run-btn" type="button">‚ñ∂ Simulation ausf√ºhren</button>
        <button class="btn" id="check-btn" type="button">Aufgabe pr√ºfen</button>
        <button class="btn" id="download-btn" type="button">Als main.py herunterladen</button>
        <span id="status" class="status">Bereit (Schnellmodus)</span>
      </div>

      <!-- Ausgabe / Ergebnisbereich -->
      <h3>Ausgabe</h3>
      <pre id="output" aria-live="polite"></pre>

      <h3>Ergebnis</h3>
      <div id="result-panel">
        <p class="result" id="result"></p>
        <ul id="result-details"></ul>
        <details id="imports-box" style="margin-top:8px">
          <summary>Gefundene Imports</summary>
          <pre id="imports-list"></pre>
        </details>
      </div>
    </section>
  </main>

  <!-- Simple Modal-Ersatz (ohne <dialog>) -->
  <div class="overlay" id="overlay"></div>

  <div class="modal" id="tips-modal">
    <div class="modal-header">Tips</div>
    <div class="modal-body">
      <ul id="tips-list"></ul>
    </div>
    <div class="modal-actions">
      <button class="btn" id="close-tips" type="button">Close</button>
    </div>
  </div>

  <div class="modal" id="solution-modal">
    <div class="modal-header">Solution</div>
    <div class="modal-body"><pre id="solution-code"></pre></div>
    <div class="modal-actions">
      <button class="btn" id="copy-solution" type="button">Insert</button>
      <button class="btn" id="close-solution" type="button">Close</button>
    </div>
  </div>

  <script>
  // ---- ganz simpler Helper ----
  function $(id){ return document.getElementById(id); }

  // ---- TASK-Daten ----
  const TASK = {
    title: "EV3 (ev3dev) ¬∑ Schritt 1: Zwei Beeps & Name",
    description: 'Aufgabe: Erzeuge <b>zwei Piept√∂ne</b> mit <b>500&nbsp;ms</b> Abstand und zeige deinen <b>Namen</b> am Display an.',
    tips: [
      'ev3dev2 verwenden: <code>from ev3dev2.sound import Sound</code>, <code>from ev3dev2.display import Display</code>.',
      'Beep: <code>sound.beep()</code> ‚Äì Pause: <code>sleep(0.5)</code>.',
      'Text: <code>screen.text_grid("Dein&nbsp;Name", x=0, y=0)</code>.',
      'Vorher l√∂schen: <code>screen.clear()</code>.',
      'Am Ende: <code>sleep(5)</code>, damit der Text sichtbar bleibt.'
    ],
    solution:
`#!/usr/bin/env python3
from ev3dev2.sound import Sound
from ev3dev2.display import Display
from time import sleep

sound = Sound()
screen = Display()

sound.beep()
sleep(0.5)
sound.beep()

screen.clear()
screen.text_grid("Hallo, ich bin Alex", x=0, y=0, clear=False)

sleep(5)`,
    filename: "main.py",
    prevUrl: "01_main.html",
    nextUrl: "#"
  };

  // ---- DOM-Refs ----
  const els = {
    title: $("task-title"),
    desc:  $("task-desc"),
    editor:$("editor"),
    run:   $("run-btn"),
    check: $("check-btn"),
    download:$("download-btn"),
    output:$("output"),
    result:$("result"),
    resultDetails:$("result-details"),
    importsList:$("imports-list"),
    importsBox:$("imports-box"),
    status:$("status"),
    tipsBtn:$("tips-btn"),
    tipsModal:$("tips-modal"),
    closeTips:$("close-tips"),
    tipsList:$("tips-list"),
    solutionBtn:$("solution-btn"),
    solutionModal:$("solution-modal"),
    closeSolution:$("close-solution"),
    copySolution:$("copy-solution"),
    overlay:$("overlay"),
    back:$("back-btn"),
    next:$("next-btn")
  };

  // ---- Seite initialisieren ----
  document.title = TASK.title;
  els.title.textContent = TASK.title;
  els.desc.innerHTML = TASK.description;
  els.tipsList.innerHTML = TASK.tips.map(t=>`<li>${t}</li>`).join("");
  $("solution-code").textContent = TASK.solution;

  // ---- Simple Modal-Logik (ohne dialog) ----
  function openModal(m){ els.overlay.style.display='block'; m.style.display='block'; }
  function closeModal(m){ els.overlay.style.display='none'; m.style.display='none'; }
  els.tipsBtn.onclick     = ()=> openModal(els.tipsModal);
  els.closeTips.onclick   = ()=> closeModal(els.tipsModal);
  els.solutionBtn.onclick = ()=> openModal(els.solutionModal);
  els.closeSolution.onclick = ()=> closeModal(els.solutionModal);
  els.overlay.onclick     = ()=>{ closeModal(els.tipsModal); closeModal(els.solutionModal); };

  els.copySolution.onclick = ()=>{
    els.editor.value = TASK.solution;
    closeModal(els.solutionModal);
    clearOut();
  };

  // ---- Tools ----
  function clearOut(){
    els.output.textContent = '';
    els.result.textContent = '';
    els.result.className = 'result';
    els.resultDetails.innerHTML = '';
    els.importsList.textContent = '';
    els.importsBox.open = false;
  }
  function detectImports(src){
    const lines = src.split(/\n/);
    const found = lines.filter(L => /^\s*(import\s+.+|from\s+\S+\s+import\s+.+)/.test(L));
    return found.join('\n') || '(keine Imports gefunden)';
  }
  function runFastSim(src){
    // Nur simple Text-Simulation, keine echten Beeps n√∂tig
    let beeps = 0;
    const lines = src.split(/\n/);
    for(const L of lines){
      if(/sound\.beep\(\)/.test(L)){ els.output.textContent += '[BEEP]\\n'; beeps++; }
      else if(/sleep\(\s*(0?\.?5|\.50|0\.500)\s*\)/.test(L)){ els.output.textContent += '[WAIT 500ms]\\n'; }
      else if(/screen\.text_grid\((.+)\)/.test(L)){
        const m = L.match(/screen\.text_grid\((.+)\)/);
        els.output.textContent += '[SCREEN] ' + (m ? m[1] : '') + '\\n';
      } else if(/screen\.clear\(\)/.test(L)){
        els.output.textContent += '[SCREEN CLEAR]\\n';
      }
    }
    // (Optional: hier k√∂nnte man WebAudio-Beep einbauen ‚Äì weggelassen f√ºr maximale Robustheit)
  }

  // ---- Checks ----
  function checkTask(){
    const code = els.editor.value;

    // Imports
    els.importsList.textContent = detectImports(code);
    els.importsBox.open = true;

    const beeps = (code.match(/sound\\.beep\\(\\)/g) || []).length;
    const hasWait500 = /sleep\\(\\s*(0?\\.?5|\\.50|0\\.500)\\s*\\)/.test(code);
    const nameMatch = code.match(/screen\\.text_grid\\(([^)]+)\\)/);
    let hasName = false;
    if(nameMatch){
      const txt = nameMatch[1].replace(/^([ru]|rb)?["']|["']\\s*$/g,'');
      hasName = /[A-Za-z√Ñ√ñ√ú√§√∂√º√ü]{2,}/.test(txt);
    }

    const details = [
      {ok: beeps >= 2, msg: (beeps>=2? '‚úì':'‚úó') + ` Mindestens 2√ó sound.beep() (gefunden: ${beeps})`},
      {ok: hasWait500, msg: (hasWait500? '‚úì':'‚úó') + ' 500 ms Pause vorhanden (sleep(0.5))'},
      {ok: hasName, msg: (hasName? '‚úì':'‚úó') + ' Name wird angezeigt (screen.text_grid("‚Ä¶"))'}
    ];
    els.resultDetails.innerHTML = details.map(d=>`<li>${d.msg}</li>`).join('');
    const ok = details.every(d=>d.ok);
    els.result.textContent = ok ? '‚úîÔ∏é Aufgabe erf√ºllt ‚Äì super!' : 'Noch nicht ganz. Pr√ºfe die Punkte oben.';
    els.result.className = 'result ' + (ok ? 'ok' : 'fail');
  }

  // ---- Events ----
  els.run.onclick = ()=>{ els.status.textContent='running‚Ä¶'; clearOut(); runFastSim(els.editor.value); els.status.textContent='done.'; };
  els.check.onclick = checkTask;
  els.download.onclick = ()=>{
    const blob = new Blob([els.editor.value], {type:'text/x-python'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = TASK.filename || 'main.py'; a.click();
    URL.revokeObjectURL(url);
  };

  // Back/Next (optional)
  els.back && (els.back.onclick = ()=> TASK.prevUrl && TASK.prevUrl!="#" ? location.href=TASK.prevUrl : alert("Kein vorheriger Schritt gesetzt."));
  els.next && (els.next.onclick = ()=> TASK.nextUrl && TASK.nextUrl!="#" ? location.href=TASK.nextUrl : alert("Kein n√§chster Schritt gesetzt."));
  </script>
</body>
</html>
