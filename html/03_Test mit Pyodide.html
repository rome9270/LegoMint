<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Step 1 â€“ Python (Pyodide) Robot in 3Ã—3 m Arena</title>

  <!-- Minimal, self-contained CSS -->
  <style>
    :root { --gap:16px; --border:#e5e7eb; --bg:#fff; --muted:#f8fafc; --text:#111; }
    body { margin:20px; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--text); }
    h1 { margin:0 0 4px 0; }
    p.lead { margin:0 0 12px 0; color:#374151; }
    .layout { display:grid; grid-template-columns: 1fr 1fr; gap:var(--gap); }
    .card { background:var(--bg); border:1px solid var(--border); border-radius:12px; padding:14px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:6px 0; }
    .btn { padding:8px 14px; border:1px solid #cdd0d5; background:#f3f4f6; border-radius:8px; cursor:pointer; }
    .btn.primary { background:#e0e7ff; }
    textarea { width:100%; height:260px; font:13.5px/1.4 monospace; border:1px solid var(--border); border-radius:10px; padding:10px; background:#fff; }
    pre { background:var(--muted); border:1px solid var(--border); border-radius:10px; padding:10px; min-height:120px; overflow:auto; }
    #arena { width:420px; height:420px; border:2px solid #111; background:#fff; display:block; }
    .nav { display:flex; justify-content:space-between; margin-top:12px; }
    dialog { border:0; border-radius:12px; max-width:560px; }
    .modal-header { padding:10px 14px; font-weight:600; border-bottom:1px solid #ddd; }
    .modal-body { padding:10px 14px; }
    .modal-actions { display:flex; justify-content:flex-end; gap:8px; padding:10px 14px; border-top:1px solid #ddd; }
    .status { font-size:.9rem; color:#4b5563; }
    @media (max-width: 900px){ .layout { grid-template-columns: 1fr; } #arena { width:100%; height:320px; } }
  </style>

  <!-- Pyodide (echtes Python im Browser) -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
</head>
<body>
  <header class="row" style="justify-content: space-between;">
    <div>
      <h1>Step 1 â€” Robot inside a 3Ã—3 m arena (Pyodide)</h1>
      <p class="lead">Use <code>robot.forward_m(m)</code>, <code>robot.forward_mm(mm)</code>, <code>robot.left(deg)</code>, <code>robot.right(deg)</code>. Border prevents leaving the field (red flash).</p>
    </div>
    <div class="row">
      <button class="btn" id="tips-btn">ðŸ’¡ Tips</button>
      <button class="btn" id="solution-btn">âœ… Solution</button>
    </div>
  </header>

  <main class="layout">
    <!-- Editor -->
    <section class="card">
      <h2>Editor</h2>
      <div class="row">
        <button class="btn primary" id="run">â–¶ Run</button>
        <button class="btn" id="reset">âŸ² Reset</button>
        <button class="btn" id="save">ðŸ’¾ Save</button>
        <span id="status" class="status"></span>
      </div>
      <textarea id="code" spellcheck="false" placeholder="# Write Python here, e.g.:
# robot.forward_m(1.2)
# robot.left(90)
# robot.forward_mm(80)
"></textarea>
    </section>

    <!-- Output + Canvas -->
    <section class="card">
      <h2>Output</h2>
      <pre id="out" aria-live="polite"></pre>
      <h3>Arena</h3>
      <canvas id="arena" width="420" height="420" aria-label="robot arena"></canvas>
    </section>
  </main>

  <!-- Tips -->
  <dialog id="tips-modal">
    <div class="modal-header">Tips</div>
    <div class="modal-body">
      <ul>
        <li>1 m = 100 px. The arena is 3Ã—3 m, centered at (0,0).</li>
        <li>Use <code>robot.forward_m(1.0)</code> or <code>robot.forward_mm(250)</code>.</li>
        <li>Rotate with <code>robot.left(90)</code> / <code>robot.right(90)</code>.</li>
      </ul>
    </div>
    <div class="modal-actions">
      <button class="btn" id="close-tips">Close</button>
    </div>
  </dialog>

  <!-- Solution -->
  <dialog id="solution-modal">
    <div class="modal-header">Solution (example)</div>
    <div class="modal-body">
<pre># Example: draw a small 'Ð“' shape inside the arena
robot.forward_m(1.0)
robot.left(90)
robot.forward_mm(120)
</pre>
    </div>
    <div class="modal-actions">
      <button class="btn" id="insert-solution">Insert</button>
      <button class="btn" id="close-solution">Close</button>
    </div>
  </dialog>

<script>
let pyodide;
const els = {
  code: document.getElementById('code'),
  run: document.getElementById('run'),
  reset: document.getElementById('reset'),
  save: document.getElementById('save'),
  out: document.getElementById('out'),
  status: document.getElementById('status'),
  canvas: document.getElementById('arena'),
  tipsBtn: document.getElementById('tips-btn'),
  tipsDlg: document.getElementById('tips-modal'),
  closeTips: document.getElementById('close-tips'),
  solBtn: document.getElementById('solution-btn'),
  solDlg: document.getElementById('solution-modal'),
  insertSol: document.getElementById('insert-solution'),
  closeSol: document.getElementById('close-solution'),
};

function setStatus(s){ els.status.textContent = s || ""; }
function printLine(s){ els.out.textContent += s + "\n"; }

async function boot(){
  setStatus("loading Pyodideâ€¦");
  pyodide = await loadPyodide();
  // Hook stdout/stderr to the Output pane
  pyodide.setStdout({batched: (s)=> { if(s) els.out.textContent += s; }});
  pyodide.setStderr({batched: (s)=> { if(s) els.out.textContent += s; }});

  // Expose canvas context + small helpers to Python
  const ctx = els.canvas.getContext('2d');
  function drawBorder(color="#111", width=2){
    ctx.strokeStyle = color; ctx.lineWidth = width;
    ctx.strokeRect( (els.canvas.width-300)/2, (els.canvas.height-300)/2, 300, 300 );
  }
  // Register small JS modules for Python side
  pyodide.registerJsModule("uiconsole", { printLine });
  pyodide.registerJsModule("uicanvas", { ctx, drawBorder });

  // Bootstrap Python environment (Robot API + arena drawing)
  await pyodide.runPythonAsync(`
from uicanvas import ctx, drawBorder
from uiconsole import printLine
import math

W, H = ctx.canvas.width, ctx.canvas.height
SCALE = 100        # 1 m = 100 px
SIZE  = 3 * SCALE  # 300 px (3 m)
ORIGIN = (W//2, H//2)  # screen center
flash = 0  # border flash frames

def clear():
    ctx.fillStyle = "#ffffff"
    ctx.fillRect(0,0,W,H)
    # Base border
    ctx.strokeStyle = "#111"; ctx.lineWidth = 2
    left = ORIGIN[0]-SIZE//2; top = ORIGIN[1]-SIZE//2
    ctx.strokeRect(left, top, SIZE, SIZE)
    if flash > 0:
        # extra red flash overlay
        drawBorder("#e11d48", 4)

def to_canvas(x, y):
    # world (0,0) center -> canvas (0,0 top-left)
    return ORIGIN[0]+x, ORIGIN[1]-y

def draw_robot(x, y, heading_deg):
    cx, cy = to_canvas(x, y)
    # draw body as circle
    ctx.fillStyle = "#0a7"
    ctx.beginPath(); ctx.arc(cx, cy, 7, 0, 2*math.pi); ctx.fill()
    # heading tick
    hx = cx + 12*math.cos(math.radians(heading_deg))
    hy = cy - 12*math.sin(math.radians(heading_deg))
    ctx.strokeStyle = "#0a7"; ctx.lineWidth = 2
    ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(hx, hy); ctx.stroke()

def beep():
    global flash
    flash = 10  # frames to flash border

class Robot:
    def __init__(self):
        self.x = -SIZE/2 + 20
        self.y = -SIZE/2 + 20
        self.heading = 0.0  # deg

    def _try_move(self, nx, ny):
        half = SIZE/2
        if (-half <= nx <= half) and (-half <= ny <= half):
            self.x, self.y = nx, ny
        else:
            beep()

    def forward_px(self, dist_px: float=20):
        rad = math.radians(self.heading)
        nx = self.x + dist_px*math.cos(rad)
        ny = self.y + dist_px*math.sin(rad)
        self._try_move(nx, ny)
        self.render()

    def forward_m(self, meters: float):
        self.forward_px(meters * SCALE)

    def forward_mm(self, mm: float):
        self.forward_px((mm/1000.0) * SCALE)

    def left(self, deg: float=90):
        self.heading = (self.heading + deg) % 360
        self.render()

    def right(self, deg: float=90):
        self.heading = (self.heading - deg) % 360
        self.render()

    def render(self):
        global flash
        clear()
        draw_robot(self.x, self.y, self.heading)
        if flash > 0:
            # decay
            flash -= 1

# Instantiate one shared robot for the user
robot = Robot()
robot.render()
printLine("Arena ready. Use robot.forward_m(m), robot.forward_mm(mm), robot.left(deg), robot.right(deg).")
  `);
  setStatus("ready");
}

// Execute user code
async function runUser(){
  if(!pyodide){ return; }
  els.out.textContent = "";
  setStatus("runningâ€¦");
  try {
    // User code runs in the same Python context, so 'robot' is available.
    await pyodide.runPythonAsync(els.code.value);
    setStatus("done.");
  } catch (e){
    els.out.textContent += String(e) + "\n";
    setStatus("error");
  }
}

// Reset environment
async function resetAll(){
  els.out.textContent = "";
  setStatus("resetâ€¦");
  await boot();
}

function saveCode(){
  const blob = new Blob([els.code.value], {type:"text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "step1_robot.py";
  a.click();
  URL.revokeObjectURL(a.href);
}

els.run.onclick = runUser;
els.reset.onclick = resetAll;
els.save.onclick = saveCode;

els.tipsBtn.onclick = ()=> els.tipsDlg.showModal();
els.closeTips.onclick = ()=> els.tipsDlg.close();
els.solBtn.onclick = ()=> els.solDlg.showModal();
els.closeSol.onclick = ()=> els.solDlg.close();
els.insertSol.onclick = ()=> { els.code.value =
`# Example: draw a small 'Ð“' shape inside the arena
robot.forward_m(1.0)
robot.left(90)
robot.forward_mm(120)
`; els.solDlg.close(); };

boot();
</script>
</body>
</html>
